<html lang="en">
<head>
	<title>CodeCraft</title>
	<!-- <link rel="shortcut icon" href="iconCoC.png">   -->
	<style>
		body {
			background-color: #000000;
			margin: 0px;
			overflow: hidden;
		}

		::-webkit-scrollbar {
			width: .0em;
		}
	</style>
</head>
<script src="https://ajax.googleapis.com/ajax/libs/threejs/r69/three.js"></script>	
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>
<link rel="stylesheet" href="jquery-ui/TechGreen.css">
<script src='craftData.js'></script>
<!-- <script src="craftData.js"></script> -->
<!-- <script src="three.min.js"></script> -->
<body oncontextmenu="return false;" onselectstart="return false;">
<center>	
	<div id='menu'>
		<button id='play'>Play</button>
		<button id='code'>Blockly</button><br>
		<button id='craft'>Select Crafts</button><br>
		<button id='runway'>Select Runway</button><br>
		<button id='assemb'>Craft Assembly</button><br>
		<button id='paint'>Craft Painting</button><br>
	</div>	
	<div id='motionStatus'>
	</div>
	<div id='selectCraft'>
		<button id='kernel'>Model-001 Kernel</button><br>
		<button id='quad'>Model-002 Quad</button><br>
		<button id='fighter'>Model-003 Fighter</button><br>
		<button id='upload'>upload ...</button>
	</div>	

	<div id='selectRunway'>
		<button id='straight'>advancing</button><br>
		<button id='lightning'>lightning</button><br>
		<button id='swinging'>swinging</button><br>	
		<button id='sawtooth'>sawtooth</button><br>
	</div>
</center>
<script>
	$("#menu").dialog({
		title:'Main Menu',
		position:{at:"center center"},
		width:150,height:230,
		resizable:false,
		draggable:false,
		open: function(){
			$(".ui-dialog-titlebar-close").hide();
		},
		show:{effect: "clip",duration: 200},
		hide:{effect: "clip",duration: 200}
	});

		$("#play").button().click(function(){
			$("#menu").dialog('close')
			$("#motionStatus").dialog('open')
			timer.start()

			renderer.domElement.requestPointerLock = 
				renderer.domElement.requestPointerLock ||
				renderer.domElement.mozRequestPointerLock ||
				renderer.domElement.webkitRequestPointerLock;
			renderer.domElement.requestPointerLock()
			renderer.domElement.addEventListener('mousemove',mousemoveReact);
			// document.addEventListener('keydown', ctrlKernel, false );
			// document.addEventListener('keyup', ctrlKernel, false );
			// document.addEventListener('keydown', ctrlQuad, false );	
			// document.addEventListener('keyup', ctrlQuad, false );
			// document.addEventListener('keydown', ctrlFight);
			// document.addEventListener('keyup', ctrlFight);	
			// setInterval('render()',60)
			runway.resetColor(1)
			setInterval('flash()',10)		
		});
		function escPress(event){
			switch(event.keyCode){
			case 27:
			// location.reload()
			timer.stop()

			console.log(timer.autoStart)
			craft.accelera.set(0,0,0)
			craft.velocity.set(0,0,0)
			// craft.position.set(0,20,-100)
			craft.position.copy(runway.checkPoint[0].position)
			craft.rotaAcce.set(0,0,0)
			craft.rotaVelo.set(0,0,0)
			craft.rotation.set(0,0,0)
			progress=0
			runway.resetColor()
			radius=200
			thita=0.5,phai=-1.55;
			// renderer.domElement.removeEventListener('mousemove', mousemoveReact);
			// document.removeEventListener('keydown', ctrlFight);
			// document.removeEventListener('keyup', ctrlFight);
			$("#menu").dialog('open');
			$('#selectCraft').dialog('close')
			$('#motionStatus').dialog('close')
			break;
			}
		}

		$("#code").button().click(function(){


		});

		$("#craft").button().click(function(){
			$("#menu").dialog('close')
			$('#selectCraft').dialog('open')
			radius=50
		});

		$("#runway").button().button().click(function(){
			$("#menu").dialog('close')
			$('#selectRunway').dialog('open')
			radius=500
		});
		$("#assemb").button()
		$("#paint").button()

		

	$('#motionStatus').dialog({
		title:'Motion Status',
		position:{at:"left bottom"},
		width:300,height:180,
		resizable:false,
		draggable:false,
		open: function(){
			$(".ui-dialog-titlebar-close").hide();
		},
		show:{effect: "clip",duration: 200},
		hide:{effect: "clip",duration: 200}
	})
	$('#motionStatus').dialog('close')

	$('#selectCraft').dialog({
		title:'Select Craft',
		position:{at:"right center"},
		width:200,height:400,
		autoOpen:false,
		resizable:false,
		draggable:false,
		open: function(){
			$(".ui-dialog-titlebar-close").hide();
		},
		show:{effect: "clip",duration: 200},
		hide:{effect: "clip",duration: 200},
		buttons: {
			'Pick Out': function() {
				$("#menu").dialog('open')
				$('#selectCraft').dialog('close')
				radius=200
			}
	  	}
	})
	$('#selectCraft').dialog('close')

		$("#kernel").button().click(function(){
			scene.remove(craft)
			buildCraft(kernel)
			scene.add(craft)
			craft.position.copy(runway.checkPoint[0].position)
			removeAllCtrl()
			document.addEventListener('keydown', ctrlKernel, false );
			document.addEventListener('keyup', ctrlKernel, false );
		})
		$("#quad").button().click(function(){
			scene.remove(craft)
			buildCraft(quadcopter)
			scene.add(craft)
			craft.position.copy(runway.checkPoint[0].position)
			removeAllCtrl()
			document.addEventListener('keydown', ctrlQuad, false );	
			document.addEventListener('keyup', ctrlQuad, false );
		})
		$("#fighter").button().click(function(){
			scene.remove(craft)
			buildCraft(fighter)
			scene.add(craft)
			craft.position.copy(runway.checkPoint[0].position)
			removeAllCtrl()
			document.addEventListener('keydown', ctrlFight, false );
			document.addEventListener('keyup', ctrlFight, false );
		})
		function removeAllCtrl(){
			document.removeEventListener('keydown',ctrlKernel);
			document.removeEventListener('keyup',ctrlKernel);
			document.removeEventListener('keydown',ctrlQuad);	
			document.removeEventListener('keyup',ctrlQuad);
			document.removeEventListener('keydown',ctrlFight);
			document.removeEventListener('keyup',ctrlFight);
		}
		$("#upload").button()

	$('#selectRunway').dialog({
		title:'Select Runway',
		position:{at:"right center"},
		width:200,height:400,
		autoOpen:false,
		resizable:false,
		draggable:false,
		open: function(){
			$(".ui-dialog-titlebar-close").hide();
		},
		show:{effect: "clip",duration: 200},
		hide:{effect: "clip",duration: 200},
		buttons: {
			'Pick Out': function() {
				$("#menu").dialog('open')
				$('#selectRunway').dialog('close')
				radius=200
			}
	  	}
	})
	$('#selectRunway').dialog('close')	

		$("#straight").button().click(function(){
			scene.remove(runway)
			buildRunway(straight)
			scene.add(runway)
		})
		$("#lightning").button().click(function(){
			scene.remove(runway)
			buildRunway(lightning)
			scene.add(runway)
		})
		$("#swinging").button().click(function(){
			scene.remove(runway)
			buildRunway(swinging)
			scene.add(runway)
		})
		$("#sawtooth").button().click(function(){
			scene.remove(runway)
			buildRunway(sawtooth)
			scene.add(runway)
		})


	// $('#tabs').tabs();

	var CoC={}
	var camera, scene, renderer;
	var windowX = window.innerWidth
	   ,windowY = window.innerHeight;
	var craft,runway,auxPlane,aimLine,background,vArrow;
	var fieldCenter
	var radius=200,thita=0.5,phai=-1.55;
	var mouseDx=0,mouseDy=0,mouseDz=0;
	var timer=new THREE.Clock(false),tt,dt

	var s3d2=Math.sqrt(3)/2,s2d2=Math.sqrt(2)/2

	var progress=0

	// init(); to the end 
	function init() {
		camera = new THREE.PerspectiveCamera(40,windowX/windowY,5,10000);
		// camera.position.set(500,100,-100)

		scene = new THREE.Scene();
		scene.fog = new THREE.FogExp2(0x000000,0.001);
		// scene.fog = new THREE.Fog( 0x000000, 3500, 15000 );
		// scene.fog.color.setHSL( 0.51, 0.4, 0.01 );

		renderer = new THREE.WebGLRenderer( { antialias: true } );
		renderer.setSize( windowX, windowY );
		renderer.setClearColor ('#000000',1)
		document.body.appendChild( renderer.domElement );

		// Default Craft
		buildCraft(kernel)	
		// buildCraft(quadcopter)	
		// buildCraft(fighter)

		document.addEventListener('keydown', ctrlKernel, false );
		document.addEventListener('keyup', ctrlKernel, false );
		// document.addEventListener('keydown', ctrlQuad, false );
		// document.addEventListener('keyup', ctrlQuad, false );
		// document.addEventListener('keydown', ctrlFight);
		// document.addEventListener('keyup', ctrlFight);
		//
			

		buildRunway(lightning)
		buildRunway(straight)
		scene.add(runway)
		// console.log(runway.checkPoint[0].visible)

		scene.add(craft)
		craft.position.copy(runway.checkPoint[0].position)

		setAuxPlane(-1,1,-1,10)
		scene.add(auxPlane)

		setBackground()
		scene.add(background)

		renderer.domElement.addEventListener('mousemove', mousemoveReact);
		renderer.domElement.addEventListener("mousewheel",mousewheelHandler);

		document.addEventListener('keydown',escPress);
		document.addEventListener('keyup',escPress);


		setInterval('render()',60)
	}

	function setBackground(){
		background=new THREE.Object3D
		var geometry = new THREE.Geometry();
		for ( var i = 0; i < 10000; i ++ ) {
			var vertex = new THREE.Vector3();
			vertex.x = THREE.Math.randFloatSpread( 2000 );
			vertex.y = THREE.Math.randFloatSpread( 2000 );
			vertex.z = THREE.Math.randFloatSpread( 2000 );
			if(vertex.length()>500){geometry.vertices.push( vertex );}
		}
		var stars=new THREE.PointCloud(geometry,new THREE.PointCloudMaterial({color:0xffffff}));
		background.add(stars);
	}

	THREE.Vector3.prototype.format=function(){
		return [
			Math.round(this.x*100)/100,
			Math.round(this.y*100)/100,
			Math.round(this.z*100)/100
		]
	}	
	THREE.Euler.prototype.format=function(){
		return [
			Math.round(this.x*100)/100,
			Math.round(this.y*100)/100,
			Math.round(this.z*100)/100,
			this.order
		]
	}

	function velocityArrow(){
		scene.remove(vArrow)

		var color=new THREE.Color(0x0000ff),head=5
		if(craft.velocity.length()<25){head=null}
		vArrow=CoC.Arrow(craft.position,craft.velocity,color,head)

		scene.add(vArrow)
	}	

	function render(){
		camera.position.x=craft.position.x+radius*Math.cos(phai)*Math.cos(thita)
		camera.position.z=craft.position.z+radius*Math.sin(phai)*Math.cos(thita)
		camera.position.y=craft.position.y+radius*Math.sin(thita)		
		camera.lookAt( craft.position );
		background.position.copy(camera.position)
		plotAimLine()
		velocityArrow()
		renderer.render( scene, camera );
		$('#motionStatus').html('<br>'+
			'accelera : '+craft.accelera.format()+'<br>'+
			'velocity : '+craft.velocity.format()+'<br>'+
			'position : '+craft.position.format()+'<br>'+
			'rotaAcce : '+craft.rotaAcce.format()+'<br>'+
			'rotaVelo : '+craft.rotaVelo.format()+'<br>'+
			'rotation : '+craft.rotation.format()
		)
	}

	function flash(){	
		var dv,dx,drv,drx	

		dt=timer.getDelta()
		tt=timer.getElapsedTime()

		if(runway.sensor(progress)==true){
			progress+=1
			if(progress==runway.children.length){
				timre.stop()
				progress=0
			}
			runway.resetColor(progress)
		}

		craft.accelera=craft.force.clone().divideScalar(craft.mass)
		craft.rotaAcce=craft.torque.clone().applyMatrix4(craft.invIner) // !! not correct
		eular=craft.rotation
		craft.accelera.applyEuler(eular)

		dv=craft.accelera.clone()
		dv.multiplyScalar(dt)
		craft.velocity.add(dv)
		dx=craft.velocity.clone()
		dx.multiplyScalar(dt)
		craft.position.add(dx)

		drv=craft.rotaAcce.clone()
		drv.multiplyScalar(dt)
		craft.rotaVelo.add(drv)
		drx=craft.rotaVelo.clone()
		drx.multiplyScalar(dt)
		craft.rotateOnAxis(drx.clone().normalize(),drx.length())
	}

	function buildCraft(model){
		craft=new THREE.Object3D()
		model=new model()

		craft.mass=model.units.length
		craft.radius=0
		craft.massCenter=new THREE.Vector3()
		craft.force=new THREE.Vector3()	
		craft.accelera=new THREE.Vector3()		
		craft.velocity=new THREE.Vector3()
		craft.inertia=new THREE.Matrix4();
		craft.torque=new THREE.Vector3()
		craft.rotaAcce=new THREE.Vector3()
		craft.rotaVelo=new THREE.Vector3()

		var shift=new THREE.Object3D()
		var units=new Array 
		for(var i=0;i<model.units.length;i++){
			var material = new THREE.SpriteMaterial({
				map:UnitTexture(model.units[i].type)
			} );
			units[i]=new THREE.Sprite( material );
			units[i].position
				.fromArray(model.units[i].position)
			shift.add(units[i])
			craft.massCenter.add(units[i].position)
		}
		craft.massCenter.multiplyScalar(1/craft.mass)
		console.log(craft.massCenter)
		
		
		console.log(shift )		

		var xp,yp,zp,rp // position relative to mass center 
		for(var i=0;i<model.units.length;i++){
			xp=units[i].position.x-craft.massCenter.x
			yp=units[i].position.y-craft.massCenter.y
			zp=units[i].position.z-craft.massCenter.z
			craft.inertia.elements[0]+= yp*yp+zp*zp
			craft.inertia.elements[5]+= xp*xp+zp*zp
			craft.inertia.elements[10]+=xp*xp+yp*yp
			craft.inertia.elements[1]-=xp*yp
			craft.inertia.elements[2]-=xp*zp
			craft.inertia.elements[6]-=yp*zp

			rp=Math.sqrt(xp*xp+yp*yp+zp*zp)
			if(rp>craft.radius){craft.radius=rp}
		}
		craft.inertia.elements[4]=craft.inertia.elements[1]
		craft.inertia.elements[8]=craft.inertia.elements[2]
		craft.inertia.elements[9]=craft.inertia.elements[6]

		var invIner=new THREE.Matrix4().getInverse(craft.inertia.clone())
		console.log(craft.mass,craft.inertia,invIner)

		var jets=new Array
		for(var i=0;i<model.jets.length;i++){
			var len=model.jets[i].len
			   ,dir=new THREE.Vector3().fromArray(model.jets[i].dir)
			   ,end=new THREE.Vector3().fromArray(model.jets[i].end)
			   ,origin,vector
			// end.sub(craft.massCenter)
			vector=dir.clone().multiplyScalar(model.jets[i].len)
			origin=end.clone().sub(vector)
			// jets[i]=CoC.Arrow(origin,vector,0xff0000)
			jets[i]=fire(end,vector)
			jets[i].name=model.jets[i].name
			jets[i].force=dir.clone().multiplyScalar(len*100)
			jets[i].torque=end.clone().cross(jets[i].force)
			jets[i].visible=false
			shift.add(jets[i])
		}
	
		craft.invIner=invIner
		console.log(shift.position.toArray())
		shift.position.sub(craft.massCenter)
		console.log(shift.position.toArray())
		craft.add(shift)

		craft.switchJets=function(name,onoff){
			if(craft.getObjectByName(name).visible==onoff)
			{return}
			craft.getObjectByName(name).visible=onoff
			
			craft.force.set(0,0,0)
			craft.torque.set(0,0,0)
			for(var i=0;i<model.jets.length;i++){
				if(jets[i].visible==false){continue}
				craft.force.add(
					jets[i].force.clone()				   
				)
				craft.torque.add(
					jets[i].torque.clone()
				)
			}
			// craft.accelera=craft.force.clone().divideScalar(craft.mass)
			// craft.rotaAcce=craft.torque.clone().applyMatrix4(craft.invIner) // !! not correct
			// eular=craft.rotation
			// craft.accelera.applyEuler(eular)
		}
	}

	function plotLine(p1,p2){
		var geometry,vertex,material,line
		geometry=new THREE.Geometry();
		vertex=new THREE.Vector3();
		vertex.fromArray(p1)
		geometry.vertices.push(vertex);
		vertex=new THREE.Vector3();
		vertex.fromArray(p2)
		geometry.vertices.push(vertex);
		material=new THREE.LineBasicMaterial({
			color:0xff0000
		})
		line=new THREE.Line(geometry,material)
		return line
	}		

	function buildRunway(model){
		var checkPoint=[],connectLine=[]
		runway=new THREE.Object3D
		fieldCenter=new THREE.Object3D
		fieldCenter.position.set(0,20,500)

		for(n=0;n<model.spot.length;n++){
			checkPoint[n]=makeCheckPoint(model.spot[n].position)			
			if(n>0){
				var p1,p2
				p1=model.spot[n].position
				p2=model.spot[n-1].position
				connectLine[n]=plotLine(p1,p2)
			}
			runway.add(checkPoint[n],connectLine[n])
		}
		checkPoint[0].visible=false
		craft.position.copy(checkPoint[0].position)
		runway.checkPoint=checkPoint

		runway.sensor=function(){
			var p=progress

			var distance=craft.position.clone()
				.sub(checkPoint[p].position).length()
			if(distance<craft.radius){
				console.log('pass gate',p)
				return true
			}
		}
		// runway.sensor(0)

		runway.resetColor=function(){
			var p=progress,i
			if(p==0){
				for(g=1;g<checkPoint.length;g++){
					checkPoint[g].visible=true
					checkPoint[g].children[0].material.color.setHSL(0,0,1)
					
					if(g>0){
						console.log(connectLine[g].geometry)
						connectLine[g].visible=true
						connectLine[g].material.color.setRGB(1,0,0)
					}	
				}
				return 0
			}

			checkPoint[0].visible=false
			for(g=1;g<checkPoint.length;g++){
				checkPoint[g].visible=false
				connectLine[g].visible=false
			}

			i=0
			for(g=p;g<p+5;g++){
				if(g>=checkPoint.length){break;}
				console.log(g)
				var H=checkPoint[g].children[0].material.color.getHSL().h
				   ,S=checkPoint[g].children[0].material.color.getHSL().s
				   ,L=checkPoint[g].children[0].material.color.getHSL().l
				checkPoint[g].visible=true
				checkPoint[g].children[0].material.color.setHSL(H,S,1-i*0.2)
				if(i>0){
					var H=connectLine[g].material.color.getHSL().h
					   ,S=connectLine[g].material.color.getHSL().s
					   ,L=connectLine[g].material.color.getHSL().l
					connectLine[g].material.color.setHSL(H,S,0.5-i*0.1)   
					connectLine[g].visible=true 
				}
				i++
			}
			
		}
		// runway.resetColor(0)
	}	

	function makeCheckPoint(position){
		var geometry,vertex,material,diamond
		var position,normal,arrow,lineColor=0xffffff
		var checkPoint=new THREE.Object3D
		var r=craft.radius
		r=4

		geometry=new THREE.Geometry();
		vertex=new THREE.Vector3(0,-r,0);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(-r,0,0);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(0, r,0);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3( r,0,0);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(0,-r,0);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(0,0,-r);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(0, r,0);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(0,0, r);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3( r,0,0);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(0,0,-r);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(-r,0,0);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(0,0, r);
		geometry.vertices.push( vertex );
		vertex=new THREE.Vector3(0,-r,0);
		geometry.vertices.push( vertex );

		material =new THREE.LineBasicMaterial({
			color:lineColor,
		})

		diamond = new THREE.Line(geometry,material)
		checkPoint.add(diamond)
		checkPoint.position.fromArray(position)
		return checkPoint
	}

	CoC.Arrow=function(origin,vector,color,head){
		var geometry,material
		var arrow,end,length,twig1,twig2,twig3
		var zz,perpen1,perpen2
		var s3d2=Math.sqrt(3)/2
		length=vector.length()
		zz=new THREE.Vector3(0,0,1)

		if(head==null){head=length*.2}
		if(vector.clone().normalize().equals(zz) ||
		   vector.clone().normalize().negate().equals(zz)){
			perpen1=new THREE.Vector3(1,0,0)
			perpen2=new THREE.Vector3(0,1,0)
		}else{
			perpen1=zz.clone().cross(vector).normalize()
			perpen2=vector.clone().cross(perpen1).normalize()
		}
		end=origin.clone().add(vector)
		twig1=origin.clone()
		 	 .add(vector.clone().setLength(length-head))
		 	 .add(perpen1.clone().setLength(.5*head/3.))
		twig2=origin.clone()
			 .add(vector.clone().setLength(length-head))
			 .add(perpen1.clone().setLength(-.25*head/3.)) 
			 .add(perpen2.clone().setLength(.5*s3d2*head/3.)) 
		twig3=origin.clone()
			 .add(vector.clone().setLength(length-head))
			 .add(perpen1.clone().setLength(-.25*head/3.)) 
			 .add(perpen2.clone().setLength(-.5*s3d2*head/3.)) 

		geometry=new THREE.Geometry();
		geometry.vertices.push(origin);
		geometry.vertices.push(end);
		geometry.vertices.push(twig1);
		geometry.vertices.push(end);
		geometry.vertices.push(twig2);
		geometry.vertices.push(end);
		geometry.vertices.push(twig3);
		material=new THREE.LineBasicMaterial({
			color:color,
		})
		arrow=new THREE.Line(geometry,material)
		return arrow
	}

	fire=function(end,vector){
		var geometry3,vertex, line,colors3 = [];

		geometry3 = new THREE.Geometry()
		// vertex=new THREE.Vector3(0,20,-90);
		geometry3.vertices.push( end);
		colors3[0]=new THREE.Color(0xffffff)
		vertex=end.clone().sub(vector)
		geometry3.vertices.push(vertex)
		colors3[1]=new THREE.Color(0xff00ff)
		vertex=end.clone().sub(vector).sub(vector)
		geometry3.vertices.push(vertex);
		colors3[2]=new THREE.Color(0x000000)

		geometry3.colors = colors3;

		material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});
		material.opacity=0.2
		line=new THREE.Line(geometry3, material );
		return line
	}

	function plotAimLine(){
		runway.remove(aimLine)
		aimLine = new THREE.Object3D
		var geometry,vertex,material,line
		// for(var i=progress;i<runway.children.length;i++){
		geometry=new THREE.Geometry();
		geometry.vertices.push(craft.position);
		geometry.vertices.push(runway.checkPoint[progress].position)
		
		material=new THREE.LineBasicMaterial({
			color:0xff0000,
		})
		// material.opacity=0.2
		line = new THREE.Line(geometry,material)
		aimLine.add( line );

		runway.add(aimLine)
	}

	// function plotLine(p1,p2){
	// 	var geometry,material,line
	// 	geometry=new THREE.Geometry();
	// 	geometry.vertices.push(p1);
	// 	geometry.vertices.push(p2)
	// 	// var color=new THREE.Color(0xff0000);
	// 	material=new THREE.LineBasicMaterial({
	// 		color:0xff0000
	// 	})
	// 	line=new THREE.Line(geometry,material)
	// 	return line
	// 	var lineObj=new THREE.Object3D
	// 	lineObj.add(line)
	// 	return lineObj
	// }

	function setAuxPlane(x1,x2,z1,z2){
		var geometry,vertex,material,line
		auxPlane = new THREE.Object3D
		for(var i=x1*10;i<=x2*10;i++){
			var j=0,k=0
			var x=i*10,y=j*10,z=k*10
			geometry=new THREE.Geometry();
			vertex=new THREE.Vector3(x,y,z+z1*100);
			geometry.vertices.push( vertex );
			vertex=new THREE.Vector3(x,y,z+z2*100);
			geometry.vertices.push( vertex );

			lineColor=0x001100
			if(i%10==0){lineColor=0x003300}
			material=new THREE.LineBasicMaterial({
				color:lineColor,
			})
			line = new THREE.Line(geometry,material)
			auxPlane.add( line );
		}
		for(var k=z1*10;k<=z2*10;k++){
			var j=0,i=0
			var x=i*10,y=j*10,z=k*10
			geometry=new THREE.Geometry();
			vertex=new THREE.Vector3(x+x1*100,y,z);
			geometry.vertices.push( vertex );
			vertex=new THREE.Vector3(x+x2*100,y,z);
			geometry.vertices.push( vertex );

			lineColor=0x001100
			if(k%10==0){lineColor=0x003300}
			if(k%100==0){lineColor=0x005500}
			// if(k==0||k==1000){lineColor=0xff0000}
			// if(k%100==0){lineColor=0x00ffff}
			material=new THREE.LineBasicMaterial({
				color:lineColor,
			})
			line = new THREE.Line(geometry,material)
			auxPlane.add( line );
		}
	}

	function UnitTexture(kind){
		var c1,c2 // color outside & inside
		switch(kind){
			case  1:c1='#ffffff'		;break; // iron
			case  2:c1='#333333'		;break; // carbon
			case  3:c1='#ff0000'		;break; // heat vibrate
			case  4:c1='#ffff00'		;break; // electromagnetic
			case  5:c1='#0000ff'		;break; // grvity subspace

			case  6:c1='#ff7575'		;break; // steel
			case  7:c1='#FFFF6F'		;break; // jet
			case  8:c1='deepskyblue'	;break; // magnet
			case  9:c1='sandybrown'	 ;break; // inertia
			case 10:c1='greenyellow'	;break; // inertia
			case 11:c1='mediumorchid'   ;break; // inertia

			case 12:c1='silver'		 ;break; // inertia

			case 13:c1='#FF0000'		;break; // inertia
			case 14:c1='gold'		   ;break; // inertia
			case 15:c1='#2828FF'		;break; // inertia
			case 16:c1='orangered'	  ;break; // inertia
			case 17:c1='#00FF00'		;break; // inertia
			case 18:c1='#9F009F'		;break; // inertia

			case 19:c1='darkred'		;break; // inertia
			case 20:c1='#5B4B00'		;break; // inertia
			case 21:c1='#000079'		;break; // inertia
			case 22:c1='#842B00'		;break; // inertia
			case 23:c1='#006000'		;break; // inertia
			case 24:c1='#460046'		;break; // inertia
		}

		var canvas=document.createElement('canvas');
		canvas.width=100;canvas.height=100
		var ctx=canvas.getContext('2d')
		var texture=new THREE.Texture(canvas)
		texture.needsUpdate=true;

		var grd = ctx.createRadialGradient(35,35, 0, 50, 50, 90);
		grd.addColorStop(0,c1);
		// grd.addColorStop(0,'#ffffff');
		grd.addColorStop(1,'#000000');
		ctx.arc(50,50,50, 0, 2 * Math.PI, false)
		ctx.fillStyle=grd;
		ctx.fill()

		return texture
	}

	function mousemoveReact(event){
		// console.log(event)
		if(event.which==1){
			renderer.domElement.style.cursor = "none"
			mouseDx=event.movementX || event.mozMovementX || event.webkitMovementX || 0;
			mouseDy=event.movementY || event.mozMovementY || event.webkitMovementY || 0;
			phai+=mouseDx*0.002
			thita+=mouseDy*0.002
			if(thita>Math.PI*0.49){thita=Math.PI*0.49}
			if(thita<-Math.PI*0.49){thita=-Math.PI*0.49}
		}else{   
			renderer.domElement.style.cursor = "crosshair"
		}
	}
	function mousewheelHandler(event){
		// console.log(event.deltaY)
		mouseDz=event.deltaY
		radius+=mouseDz/20
	}	

	function ctrlKernel(event){
		trigger=false
		if(event.type=='keydown'){trigger=true}

		var key=String.fromCharCode(event.keyCode)
		switch(key){
		case 'A':
			craft.switchJets('left',trigger);break;
		case 'F':
			craft.switchJets('right',trigger);break;
		case 'E':
			craft.switchJets('front',trigger);break;
		case 'D':
			craft.switchJets('back',trigger);break;
		case 'W':
			craft.switchJets('up',trigger);break;
		case 'S':
			craft.switchJets('down',trigger);break;
		}
	}

	function ctrlQuad(event){
		trigger=false
		if(event.type=='keydown'){trigger=true}

		var key=String.fromCharCode(event.keyCode)
		switch(key){
		case 'A':
			craft.switchJets('left-up',trigger);
			craft.switchJets('right-down',trigger);
			break;
		case 'F':
			craft.switchJets('left-down',trigger);
			craft.switchJets('right-up',trigger);
			break;
		case 'E':
			craft.switchJets('front-up',trigger);
			craft.switchJets('back-down',trigger);
			break;
		case 'D':
			craft.switchJets('front-down',trigger);
			craft.switchJets('back-up',trigger);
			break;
		case 'W':
			craft.switchJets('left-down',trigger);
			craft.switchJets('right-down',trigger);
			craft.switchJets('front-down',trigger);
			craft.switchJets('back-down',trigger);
			break;
		case 'S':
			craft.switchJets('left-up',trigger);
			craft.switchJets('right-up',trigger);
			craft.switchJets('front-up',trigger);
			craft.switchJets('back-up',trigger);
			break;
		}
	}

	function ctrlFight(event){
		trigger=false
		if(event.type=='keydown'){trigger=true}
		var key=String.fromCharCode(event.keyCode)
		switch(key){
		case 'A':
			craft.switchJets('left-down',trigger);
			craft.switchJets('right-up',trigger);
			break;
		case 'F':
			craft.switchJets('left-up',trigger);
			craft.switchJets('right-down',trigger)
			;break;
		case 'E':
			craft.switchJets('back-1',trigger);
			craft.switchJets('back-2',trigger);
			craft.switchJets('back-3',trigger);
			craft.switchJets('back-4',trigger);break;
		case 'D':
			craft.switchJets('left-1',trigger);
			craft.switchJets('right-1',trigger);
			craft.switchJets('up',trigger);
			craft.switchJets('down',trigger);break;
		case 'W':
			craft.switchJets('up',trigger);
			craft.switchJets('back-0',trigger);break;
		case 'S':
			craft.switchJets('down',trigger);
			craft.switchJets('back-0',trigger);break;
		case 'Q':
			craft.switchJets('left-1',trigger);
			craft.switchJets('back-0',trigger);break;	
		case 'R':
			craft.switchJets('right-1',trigger);
			craft.switchJets('back-0',trigger);break;
		}
	}

	var straight={
		"cocType":"path",
		"spot":[
		{"position":[0,20,-100],"direction":[0,0,1]},
		{"position":[0,20,-50],"direction":[0,0,1]},
		{"position":[0,20,  0],"direction":[0,0,1]},
		{"position":[0,20, 50],"direction":[0,0,1]},
		{"position":[0,20,100],"direction":[0,0,1]},
		{"position":[0,20,150],"direction":[0,0,1]},
		{"position":[0,20,200],"direction":[0,0,1]},
		{"position":[0,20,250],"direction":[0,0,1]},
		{"position":[0,20,300],"direction":[0,0,1]},
		{"position":[0,20,350],"direction":[0,0,1]},
		{"position":[0,20,400],"direction":[0,0,1]},
		{"position":[0,20,450],"direction":[0,0,1]},
		{"position":[0,20,500],"direction":[0,0,1]},
		{"position":[0,20,550],"direction":[0,0,1]},
		{"position":[0,20,600],"direction":[0,0,1]},
		{"position":[0,20,650],"direction":[0,0,1]},
		{"position":[0,20,700],"direction":[0,0,1]},
		{"position":[0,20,750],"direction":[0,0,1]},
		{"position":[0,20,800],"direction":[0,0,1]},
		{"position":[0,20,850],"direction":[0,0,1]},
		{"position":[0,20,900],"direction":[0,0,1]},
		{"position":[0,20,950],"direction":[0,0,1]},
		{"position":[0,20,1000],"direction":[0,0,1]},
		]
	}

	var sawtooth={
		"cocType":"path",
		"spot":[
		{"position":[0,20,-100],"direction":[0,0,1]},
		{"position":[0,50,-100],"direction":[0,0,1]},
		{"position":[0,20,  0],"direction":[0,0,1]},
		{"position":[0,50,  0],"direction":[0,0,1]},
		{"position":[0,20,100],"direction":[0,0,1]},
		{"position":[0,50,100],"direction":[0,0,1]},
		{"position":[0,20,200],"direction":[0,0,1]},
		{"position":[0,50,200],"direction":[0,0,1]},
		{"position":[0,20,300],"direction":[0,0,1]},
		{"position":[0,50,300],"direction":[0,0,1]},
		{"position":[0,20,400],"direction":[0,0,1]},
		{"position":[0,50,400],"direction":[0,0,1]},
		{"position":[0,20,500],"direction":[0,0,1]},
		{"position":[0,50,500],"direction":[0,0,1]},
		{"position":[0,20,600],"direction":[0,0,1]},
		{"position":[0,50,600],"direction":[0,0,1]},
		{"position":[0,20,700],"direction":[0,0,1]},
		{"position":[0,50,700],"direction":[0,0,1]},
		{"position":[0,20,800],"direction":[0,0,1]},
		{"position":[0,50,800],"direction":[0,0,1]},
		{"position":[0,20,900],"direction":[0,0,1]},
		{"position":[0,50,900],"direction":[0,0,1]},
		{"position":[0,20,1000],"direction":[0,0,1]},
		]
	}

	var lightning={
		"cocType":"path",
		"spot":[
		{"position":[   0,20,-100],"direction":[0,0,1]},
		{"position":[   0,20,-50],"direction":[0,0,1]},
		{"position":[ 100,20,  0],"direction":[0,0,1]},
		{"position":[   0,20, 50],"direction":[0,0,1]},
		{"position":[-100,20,100],"direction":[0,0,1]},
		{"position":[   0,20,150],"direction":[0,0,1]},
		{"position":[ 100,20,200],"direction":[0,0,1]},
		{"position":[   0,20,250],"direction":[0,0,1]},
		{"position":[-100,20,300],"direction":[0,0,1]},
		{"position":[   0,20,350],"direction":[0,0,1]},
		{"position":[ 100,20,400],"direction":[0,0,1]},
		{"position":[   0,20,450],"direction":[0,0,1]},
		{"position":[-100,20,500],"direction":[0,0,1]},
		{"position":[   0,20,550],"direction":[0,0,1]},
		{"position":[ 100,20,600],"direction":[0,0,1]},
		{"position":[   0,20,650],"direction":[0,0,1]},
		{"position":[-100,20,700],"direction":[0,0,1]},
		{"position":[   0,20,750],"direction":[0,0,1]},
		{"position":[ 100,20,800],"direction":[0,0,1]},
		{"position":[   0,20,850],"direction":[0,0,1]},
		{"position":[-100,20,900],"direction":[0,0,1]},
		{"position":[   0,20,950],"direction":[0,0,1]},
		{"position":[ 100,20,1000],"direction":[0,0,1]},
		]
	}

	var swinging={
		"cocType":"path",
		"spot":[
		{"position":[   0,20,-100],"direction":[0,0,1]},
		{"position":[   0,20,-50],"direction":[0,0,1]},
		{"position":[ 100,50,  0],"direction":[0,0,1]},
		{"position":[   0,20, 50],"direction":[0,0,1]},
		{"position":[-100,50,100],"direction":[0,0,1]},
		{"position":[   0,20,150],"direction":[0,0,1]},
		{"position":[ 100,50,200],"direction":[0,0,1]},
		{"position":[   0,20,250],"direction":[0,0,1]},
		{"position":[-100,50,300],"direction":[0,0,1]},
		{"position":[   0,20,350],"direction":[0,0,1]},
		{"position":[ 100,50,400],"direction":[0,0,1]},
		{"position":[   0,20,450],"direction":[0,0,1]},
		{"position":[-100,50,500],"direction":[0,0,1]},
		{"position":[   0,20,550],"direction":[0,0,1]},
		{"position":[ 100,50,600],"direction":[0,0,1]},
		{"position":[   0,20,650],"direction":[0,0,1]},
		{"position":[-100,50,700],"direction":[0,0,1]},
		{"position":[   0,20,750],"direction":[0,0,1]},
		{"position":[ 100,50,800],"direction":[0,0,1]},
		{"position":[   0,20,850],"direction":[0,0,1]},
		{"position":[-100,50,900],"direction":[0,0,1]},
		{"position":[   0,20,950],"direction":[0,0,1]},
		{"position":[ 100,50,1000],"direction":[0,0,1]},
		]
	}	

	init();
</script>
</body>
</html>
